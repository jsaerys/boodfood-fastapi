{% extends "base.html" %}

{% block title %}Reserva tu Mesa - BoodFood{% endblock %}

{% block extra_css %}
<style>
.reservas-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 80px 0 60px;
    text-align: center;
}

.reservas-hero h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.reservas-hero p {
    font-size: 1.2rem;
    opacity: 0.95;
}

.reserva-container {
    max-width: 800px;
    margin: -40px auto 60px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    padding: 40px;
    position: relative;
    z-index: 10;
}

.form-section {
    margin-bottom: 30px;
}

.form-section h3 {
    color: #2d3748;
    margin-bottom: 20px;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 8px;
    font-size: 0.95rem;
}

.form-control {
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-control:disabled {
    background: #f7fafc;
    cursor: not-allowed;
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

.zona-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 10px;
}

.zona-btn {
    padding: 12px 20px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
    color: #4a5568;
    text-align: center;
}

.zona-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.zona-btn.active {
    border-color: #667eea;
    background: #667eea;
    color: white;
}

.mesas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
}

.mesa-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.mesa-card:hover:not(.ocupada) {
    border-color: #667eea;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
}

.mesa-card.seleccionada {
    border-color: #48bb78;
    background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 50%);
}

.mesa-card.ocupada {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f7fafc;
}

.mesa-numero {
    font-size: 1.8rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 8px;
}

.mesa-info {
    font-size: 0.9rem;
    color: #718096;
}

.mesa-capacidad {
    display: block;
    margin-top: 5px;
    font-weight: 600;
}

.mesa-ubicacion {
    display: inline-block;
    padding: 4px 8px;
    background: #edf2f7;
    border-radius: 6px;
    font-size: 0.85rem;
    margin-top: 8px;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
    padding-top: 30px;
    border-top: 2px solid #e2e8f0;
}

.btn {
    padding: 14px 32px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
}

.btn-secondary:hover {
    background: #667eea;
    color: white;
}

.alert {
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.alert-info {
    background: #bee3f8;
    color: #2c5282;
    border-left: 4px solid #3182ce;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #718096;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e2e8f0;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .reservas-hero h1 {
        font-size: 2rem;
    }
    
    .reserva-container {
        margin: -30px 20px 40px;
        padding: 25px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column-reverse;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="reservas-hero">
    <div class="container">
        <h1>üçΩÔ∏è Reserva tu Mesa</h1>
        <p>Asegura tu lugar en BoodFood</p>
    </div>
</div>

<div class="container">
    <div class="reserva-container">
        <form id="form-reserva">
            <!-- Fecha y Hora -->
            <div class="form-section">
                <h3>üìÖ ¬øCu√°ndo nos visitas?</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fecha">Fecha *</label>
                        <input type="date" id="fecha" name="fecha" class="form-control" required 
                               min="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="form-group">
                        <label for="hora">Hora *</label>
                        <input type="time" id="hora" name="hora" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="numero_personas">N√∫mero de Personas *</label>
                        <input type="number" id="numero_personas" name="numero_personas" 
                               class="form-control" min="1" max="20" value="2" required>
                    </div>
                </div>
            </div>

            <!-- Selecci√≥n de Mesa -->
            <div class="form-section">
                <h3>ü™ë Selecciona tu Mesa</h3>
                
                <div class="form-group">
                    <label>Filtrar por zona</label>
                    <div class="zona-selector">
                        <button type="button" class="zona-btn active" data-zona="todas" onclick="filtrarZona('todas')">
                            Todas
                        </button>
                        <button type="button" class="zona-btn" data-zona="interior" onclick="filtrarZona('interior')">
                            Interior
                        </button>
                        <button type="button" class="zona-btn" data-zona="terraza" onclick="filtrarZona('terraza')">
                            Terraza
                        </button>
                        <button type="button" class="zona-btn" data-zona="vip" onclick="filtrarZona('vip')">
                            VIP
                        </button>
                    </div>
                </div>

                <input type="hidden" id="mesa_id" name="mesa_id" required>
                
                <div id="mesas-container" class="mesas-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando mesas disponibles...</p>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Cliente -->
            <div class="form-section">
                <h3>üë§ Tus Datos</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombre_cliente">Nombre Completo *</label>
                        <input type="text" id="nombre_cliente" name="nombre_cliente" 
                               class="form-control" required
                               value="{{ current_user.nombre if current_user.is_authenticated else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="telefono">Tel√©fono *</label>
                        <input type="tel" id="telefono" name="telefono" 
                               class="form-control" required placeholder="3001234567"
                               value="{{ current_user.telefono if current_user.is_authenticated else '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="email">Correo Electr√≥nico (opcional)</label>
                    <input type="email" id="email" name="email" class="form-control"
                           placeholder="tu@email.com"
                           value="{{ current_user.email if current_user.is_authenticated else '' }}">
                </div>
            </div>

            <!-- Notas Especiales -->
            <div class="form-section">
                <h3>üí¨ Notas Especiales</h3>
                <div class="form-group">
                    <label for="notas_especiales">¬øAlgo que debamos saber?</label>
                    <textarea id="notas_especiales" name="notas_especiales" 
                              class="form-control" 
                              placeholder="Ocasi√≥n especial, alergias alimentarias, preferencias especiales..."></textarea>
                </div>
            </div>

            <div class="alert alert-info">
                ‚ÑπÔ∏è <strong>Importante:</strong> Las reservas deben hacerse con al menos 2 horas de anticipaci√≥n. 
                Tiempo de tolerancia: 15 minutos.
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary" id="btn-confirmar" disabled>
                    Confirmar Reserva
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let mesaSeleccionada = null;
let mesasDisponibles = [];

// Cargar mesas al inicializar
document.addEventListener('DOMContentLoaded', () => {
    cargarMesas();
    
    // Escuchar cambios en fecha/hora para actualizar disponibilidad
    document.getElementById('fecha').addEventListener('change', verificarDisponibilidad);
    document.getElementById('hora').addEventListener('change', verificarDisponibilidad);
    document.getElementById('numero_personas').addEventListener('change', cargarMesas);
});

async function cargarMesas() {
    const container = document.getElementById('mesas-container');
    const numPersonas = parseInt(document.getElementById('numero_personas').value) || 2;
    
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Cargando mesas...</p></div>';
    
    try {
        const response = await fetch('/api/mesas?estado=disponible');
        const data = await response.json();
        
        mesasDisponibles = data.mesas || [];
        
        // Filtrar por capacidad
        const mesasFiltradas = mesasDisponibles.filter(mesa => mesa.capacidad >= numPersonas);
        
        if (mesasFiltradas.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üòï</div>
                    <h3>No hay mesas disponibles</h3>
                    <p>Para ${numPersonas} personas. Intenta con menos personas o contacta al restaurante.</p>
                </div>
            `;
            return;
        }
        
        renderizarMesas(mesasFiltradas);
        verificarDisponibilidad();
    } catch (error) {
        console.error('Error al cargar mesas:', error);
        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #e53e3e;">Error al cargar mesas</div>';
    }
}

function renderizarMesas(mesas) {
    const container = document.getElementById('mesas-container');
    
    container.innerHTML = mesas.map(mesa => `
        <div class="mesa-card" data-mesa-id="${mesa.id}" data-zona="${mesa.ubicacion}" 
             onclick="seleccionarMesa(${mesa.id}, '${mesa.numero}')">
            <div class="mesa-numero">Mesa ${mesa.numero}</div>
            <div class="mesa-info">
                <span class="mesa-capacidad">üë• ${mesa.capacidad} personas</span>
                <span class="mesa-ubicacion">${mesa.ubicacion}</span>
            </div>
        </div>
    `).join('');
}

function seleccionarMesa(id, numero) {
    const card = document.querySelector(`[data-mesa-id="${id}"]`);
    
    if (card.classList.contains('ocupada')) return;
    
    // Remover selecci√≥n previa
    document.querySelectorAll('.mesa-card').forEach(c => c.classList.remove('seleccionada'));
    
    // Seleccionar nueva mesa
    card.classList.add('seleccionada');
    mesaSeleccionada = { id, numero };
    document.getElementById('mesa_id').value = id;
    document.getElementById('btn-confirmar').disabled = false;
}

function filtrarZona(zona) {
    // Actualizar botones
    document.querySelectorAll('.zona-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.zona === zona);
    });
    
    // Filtrar mesas
    document.querySelectorAll('.mesa-card').forEach(card => {
        if (zona === 'todas' || card.dataset.zona === zona) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

async function verificarDisponibilidad() {
    const fecha = document.getElementById('fecha').value;
    const hora = document.getElementById('hora').value;
    
    if (!fecha || !hora) return;
    
    try {
        const response = await fetch(`/api/reservas/disponibilidad?fecha=${fecha}&hora=${hora}`);
        const data = await response.json();
        
        // Marcar mesas ocupadas
        document.querySelectorAll('.mesa-card').forEach(card => {
            const mesaId = parseInt(card.dataset.mesaId);
            if (data.mesas_ocupadas && data.mesas_ocupadas.includes(mesaId)) {
                card.classList.add('ocupada');
                if (mesaSeleccionada && mesaSeleccionada.id === mesaId) {
                    card.classList.remove('seleccionada');
                    mesaSeleccionada = null;
                    document.getElementById('mesa_id').value = '';
                    document.getElementById('btn-confirmar').disabled = true;
                }
            } else {
                card.classList.remove('ocupada');
            }
        });
    } catch (error) {
        console.error('Error al verificar disponibilidad:', error);
    }
}

// Enviar formulario
document.getElementById('form-reserva').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!mesaSeleccionada) {
        alert('Por favor selecciona una mesa');
        return;
    }
    
    const btnConfirmar = document.getElementById('btn-confirmar');
    btnConfirmar.disabled = true;
    btnConfirmar.textContent = 'Procesando...';
    
    const formData = {
        fecha: document.getElementById('fecha').value,
        hora: document.getElementById('hora').value,
        numero_personas: parseInt(document.getElementById('numero_personas').value),
        mesa_id: mesaSeleccionada.id,
        nombre_cliente: document.getElementById('nombre_cliente').value,
        telefono: document.getElementById('telefono').value,
        email: document.getElementById('email').value || null,
        notas_especiales: document.getElementById('notas_especiales').value || null
    };
    
    try {
        const response = await fetch('/api/reservas/crear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(`¬°Reserva confirmada! üéâ\n\nC√≥digo de reserva: ${result.codigo_reserva}\n\nMesa ${mesaSeleccionada.numero}\n${formData.fecha} a las ${formData.hora}\n${formData.numero_personas} personas\n\nTe esperamos en BoodFood!`);
            window.location.href = '/';
        } else {
            alert('Error: ' + (result.error || 'No se pudo crear la reserva'));
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Reserva';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear la reserva. Por favor intenta nuevamente.');
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = 'Confirmar Reserva';
    }
});
</script>
{% endblock %}
